---
title: "Model Building"
author: "Elisabeth Nelson"
date: "2022-10-20"
output: pdf_document
---
## Load Packages
```{r}
#library(rjags)
library(MCMCpack)
library(stats)
library(CARBayes) # <- this is the package for the model
library(rgdal) # <- for working with shapefiles
library(RColorBrewer) 
library(ggplot2)
library(rgeos) # <- also for working with shapefiles
library(maptools) # shapefiles again
library(spdep) # still shapefiles 
library(ggmap) # plotting shapefiles 
library(sf)
library(dplyr)
library(tidyverse)
library(CARBayesST)

```


## Set-up for Carbays
```{r}
# Number of spatial units (e.g., districts in MDR)
n.district <- 134

# Create an n x􏰀 n identity matrix
Id.mat <- diag(n.district)

MDR_2 <- st_read(dsn = '/Users/zoe/Documents/Yale EMD/Rotation 1/Dengue - Vietnam/dengue_exploration/Data/MDR Updated map/VMD_districts_2022.shp')

```

## Neighbor Matrix
```{r}
# Neighbors can either be Queen (any zip that touches another zip - even at 
# corners) or Rook neighbors (share full sides -- not corners)

# The snap dist is governing the NA in neighbor matrix
# Can remove SNAP statement; if Queen = F then single point touch not allowed 
# and Rook distance used.

# When data is missing -- there's more non-zero links involved 
# Try to make snap distance as small as possible while making sure all states 
# have at least one neighbor
neighb <- poly2nb(MDR_2, queen = T, snap = sqrt(0.001))

# Check average number of links -- increase snap distance if it says there is 
# a zip with zero neighbors
neighb # Avg Number of links = 5.19403 
  # regions 74 nand 76 have no links --> islands Kien Hai/District + Phu Quoc/City

# Make neighbor matrix 
# if zero.policy FALSE stop with error for any empty neighbour sets, 
# if TRUE permit the weights list to be formed with zero-length weights vectors
# B is the basic binary coding, W is row standardised (both are commonly used)
neighb.mat <- nb2mat(neighb, zero.policy = T, style = 'B')

    # the island will not have neighbors, so need to exclude it at first
neighb.mat_1 <- neighb.mat[-74, -74]
neighb.mat_2 <- neighb.mat_1[-75, -75]



# For Leroux model, neighbor matrix needs to have 0 if not neighboring, -1 if 
# neighbor, and # of neighbors for each state on diagonal), so...
w.mat <- ifelse(neighb.mat==1,-1,neighb.mat)
num.neigh <- colSums(neighb.mat) # Count the number of neighbors for each state
for (i in 1:nrow(w.mat)) { # Put the number of neighbors on diagonal
  for (j in 1:ncol(w.mat)) {
    if (i==j) {
      w.mat[i,j] <- num.neigh[i]
    }
  }
}
# w.mat <- array(NA, dim=c(n.stzipcode,n.zipcode,n.countries))
# w.mat[,,1] <- ifelse(neighb.mat==1,-1,neighb.mat) # Replace 1 with -1
# num.neigh <- colSums(neighb.mat) # Count the number of neighbors for each state
# for (i in 1:nrow(w.mat[,,1])) { # Put the number of neighbors on diagonal
#   for (j in 1:ncol(w.mat[,,1])) {
#     if (i==j) {
#       w.mat[i,j,1] <- num.neigh[i]
#     }
#   }
# }


# could eventually define neighbors for the islands based on spatial adjacency/transport
# could also separately analyze them once we have a model and see if it predcits well in them independently

```

## Set up Data Frame for Model Training
```{r}

# create data frame
base_model_2001_2006 <- fortify(MDR_Dengue_map) %>%
  dplyr::select(NAME_1, VARNAME_2, ENGTYPE_2, district, total_DHF_cases, year, m1, m2, m3, m4, m5, m6, m7, m8, m9, m10, m11, m12, updated_district_code.y, pop, DHF_incidence, log_DHF_incidence, geometry) 

base_model_2001_2006 <- base_model_2001_2006 %>% 
  filter(between(year, 2001, 2006))

# fix districts that are missing years 
colnames(base_model_2001_2006)

geom_1 <- MDR_Dengue_map[1033, ]$geometry
geom_2 <- MDR_Dengue_map[713, ]$geometry
geom_3 <- MDR_Dengue_map[217, ]$geometry
geom_4 <- MDR_Dengue_map[270, ]$geometry
geom_5 <- MDR_Dengue_map[481, ]$geometry
geom_6 <- MDR_Dengue_map[514, ]$geometry
geom_7 <- MDR_Dengue_map[529, ]$geometry
geom_8 <- MDR_Dengue_map[598, ]$geometry
geom_9 <- MDR_Dengue_map[611, ]$geometry
geom_10 <- MDR_Dengue_map[680, ]$geometry
geom_11 <- MDR_Dengue_map[1033, ]$geometry
geom_12 <- MDR_Dengue_map[1048, ]$geometry
geom_13 <- MDR_Dengue_map[1067, ]$geometry
geom_14 <- MDR_Dengue_map[1082, ]$geometry
geom_15 <- MDR_Dengue_map[1097, ]$geometry
geom_16 <- MDR_Dengue_map[1112, ]$geometry
geom_17 <- MDR_Dengue_map[1647, ]$geometry
geom_18 <- MDR_Dengue_map[1735, ]$geometry

correction_df <- data.frame(NAME_1 = c(rep("Hậu Giang", 3), rep("Cà Mau", 3), "Bạc Liêu", rep("Bạc Liêu", 5), rep("Cần Thơ", 3), rep("Cần Thơ", 3), rep("Cần Thơ", 3), rep("Cần Thơ", 5), rep("Cần Thơ", 3), rep("Cà Mau", 3), rep("Hậu Giang", 3), rep("Hậu Giang", 3), rep("Hậu Giang", 14), rep("Hậu Giang", 3), rep("Hậu Giang", 3), rep("Hậu Giang", 3), rep("Sóc Trăng", 2), rep("Sóc Trăng", 3)),
                            VARNAME_2 = c(rep("Chau Thanh A", 3), rep("Phu Tan", 3), "Dong Hai", rep("Hoa Binh", 5), rep("Binh Thuy", 3), rep("Cai Rang", 3), rep("Ninh Kieu", 3), rep("Thoi Lai", 5), rep("Vinh Thanh", 3), rep("Nam Can", 3), rep("Chau Thanh A", 3), rep("Long My", 3), rep("Long My", 14), rep("Phung Hiep", 3), rep("Vi Thanh", 3), rep("Vi Thuy", 3), rep("Cu Lao Dung", 2), rep("Nga Nam", 3)),
                            ENGTYPE_2 = c(rep("District", 3), rep("District", 3), "District", rep("District", 5), rep("Urban District", 3), rep("Urabn District", 3), rep("Urban District", 3), rep("District", 5), rep("District", 3), rep("District", 3), rep("District", 3), rep("District", 3), rep("Town", 14), rep("District", 3), rep("City", 3), rep("District", 3), rep("District", 2), rep("Town", 3)),
                            district = c(rep("châu thành a", 3), rep("phú tân", 3), "đông hải", rep("hoà bình", 5), rep("bình thủy", 3), rep("cái răng", 3), rep("ninh kiều", 3), rep("thới lai", 5), rep("vĩnh thạnh", 3), rep("năm căn", 3), rep("châu thành a", 3), rep("long mỹ", 3), rep("tx. long mỹ", 14), rep("phụng hiệp", 3), rep("vị thanh", 3), rep("vị thủy", 3), rep("cù lao dung", 2), rep("ngã năm", 3)),
                            total_DHF_cases = c(rep(NA, 3), rep(NA, 3), NA, rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 14), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 2), rep(NA, 3)),
                            year = c(2001, 2002, 2003, 2001, 2002, 2003, 2001, 2001, 2002, 2003, 2004, 2005, 2001, 2002, 2003, 2001, 2002, 2003, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2001, 2002, 2003, 2001, 2002, 2003, 2001, 2002, 2003, 2001, 2002, 2003, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2001, 2002, 2003, 2001, 2002, 2003, 2001, 2002, 2003, 2001, 2002, 2001, 2002, 2003),
                            m1 = c(rep(NA, 3), rep(NA, 3), NA, rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 14), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 2), rep(NA, 3)), 
                            m2 = c(rep(NA, 3), rep(NA, 3), NA, rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 14), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 2), rep(NA, 3)), 
                            m3 = c(rep(NA, 3), rep(NA, 3), NA, rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 14), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 2), rep(NA, 3)), 
                            m4 = c(rep(NA, 3), rep(NA, 3), NA, rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 14), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 2), rep(NA, 3)), 
                            m5 = c(rep(NA, 3), rep(NA, 3), NA, rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 14), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 2), rep(NA, 3)), 
                            m6 = c(rep(NA, 3), rep(NA, 3), NA, rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 14), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 2), rep(NA, 3)),
                            m7 = c(rep(NA, 3), rep(NA, 3), NA, rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 14), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 2), rep(NA, 3)),
                            m8 = c(rep(NA, 3), rep(NA, 3), NA, rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 14), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 2), rep(NA, 3)),
                            m9 = c(rep(NA, 3), rep(NA, 3), NA, rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 14), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 2), rep(NA, 3)),
                            m10 = c(rep(NA, 3), rep(NA, 3), NA, rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 14), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 2), rep(NA, 3)),
                            m11 = c(rep(NA, 3), rep(NA, 3), NA, rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 14), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 2), rep(NA, 3)),
                            m12 = c(rep(NA, 3), rep(NA, 3), NA, rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 14), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 2), rep(NA, 3)),
                            updated_district_code.y = c(rep(59, 3), rep(42, 3), 13, rep(16, 5), rep(28, 3), rep(30, 3), rep(31, 3), rep(35, 5), rep(36, 3), rep(40, 3), rep(59, 3), rep(60, 3), rep(61, 14), rep(63, 3), rep(64, 3), rep(65, 3), rep(97, 2), rep(102, 3)),
                            pop = c(rep(107700, 3), rep(105009, 3), 152619, rep(117753, 5), rep(142164, 3), rep(105393, 3), rep(280494, 3), rep(109684, 5), rep(98399, 3), rep(66636, 3), rep(107700, 3), rep(78000, 3), rep(78000, 14), rep(210089, 3), rep(97200, 3), rep(96500, 3), rep(58304, 2), rep(74115, 3)),
                            DHF_incidence = c(rep(NA, 3), rep(NA, 3), NA, rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 14), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 2), rep(NA, 3)),
                            log_DHF_incidence = c(rep(NA, 3), rep(NA, 3), NA, rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 5), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 14), rep(NA, 3), rep(NA, 3), rep(NA, 3), rep(NA, 2), rep(NA, 3)),
                            geometry = c(rep(geom_1, 3), rep(geom_2, 3), geom_3, rep(geom_4, 5), rep(geom_5, 3), rep(geom_6, 3), rep(geom_7, 3), rep(geom_8, 5), rep(geom_9, 3), rep(geom_10, 3), rep(geom_11, 3), rep(geom_12, 3), rep(geom_13, 14), rep(geom_14, 3), rep(geom_15, 3), rep(geom_16, 3), rep(geom_17, 2), rep(geom_18, 3))
                            )
correction_df <- correction_df %>%
  filter(year <= 2006)
correction_df <- st_sf(correction_df)

base_model_2001_2006 <- base_model_2001_2006 %>%
  rbind(correction_df)

# make month 12 data missing
base_model_2001_2006 <- base_model_2001_2006 %>%
  mutate(m12 = case_when(year == 2006 ~ NA))

# rotate month variables into one column
base_model_2001_2006 <- base_model_2001_2006 %>%
  pivot_longer(cols = starts_with("m"), 
               values_to = "m_DHF_cases", 
               names_to = "month")

# take out islands Kien Hai/District + Phu Quoc/City
base_model_2001_2006_1 <- base_model_2001_2006 %>%
  filter(VARNAME_2 != "Kien Hai", 
         VARNAME_2 != "Phu Quoc")

# correct structure for model
base_model_2001_2006_1 <- base_model_2001_2006_1 %>%
  arrange(month, NAME_1, VARNAME_2)

#seasonality_matrix <- model.matrix(~ as.factor(month), data = base_model_2001_2006)

# x_model for seasonality
x_model <- base_model_2001_2006 %>%
  dplyr::select(m_DHF_cases, month)

x_model_1 <- base_model_2001_2006_1 %>%
  dplyr::select(m_DHF_cases, month)

# checking normality of population dist for offset model
hist(MDR_Dengue_map$pop, breaks = 20) 
hist(base_model_2001_2006_1$pop, breaks = 20) 

# set offset model
offset_model <- log(base_model_2001_2006_1$pop)

# arrange by month and then province, then district

# need 72 unique obs for each district --> can put in as missing for ones with less 

# if still not working, can throw out the weirds ones at first
```
tidyr complete function --> will fill all the variables (Dan has sample code)

## Check Number of rows for each district before running new model
want there to be the same number for every district (12*years)
```{r}

## figuring out problems
for(j in 1: length(unique(base_model_2001_2006_1$VARNAME_2))){
  print(sum(base_model_2001_2006_1$VARNAME_2 == unique(base_model_2001_2006_1$VARNAME_2)[j]))
  if( sum(base_model_2001_2006_1$VARNAME_2 == unique(base_model_2001_2006_1$VARNAME_2)[j]) != 72) {
    print(unique(base_model_2001_2006_1$VARNAME_2)[j])
  }
}

for(j in 1: length(unique(base_model_2001_2006_1$geometry))){
  print(sum(base_model_2001_2006_1$geometry == unique(base_model_2001_2006_1$geometry)[j]))
  if( sum(base_model_2001_2006_1$geometry == unique(base_model_2001_2006_1$geometry)[j]) != 72) {
    print(unique(base_model_2001_2006_1$VARNAME_2)[j])
  }
}

```

Chau Thanh in Hậu Giang Province begins in 2004 x
Phu Tan in Cà Mau begins in 2004 x
Dong Hai begins in 2002 x 
Hoa Binh begins in 2006 x
Binh Thuy begins in 2004 x
Cai Rang begins in 2004 x
Ninh Kieu begins in 2004 x
Thoi Lai is missing 2004-2008 x
Vinh Thanh begins in 2004 x
Nam Can begins in 2004 x
Cao Lanh has a district and city --> 36 years
Chau Thanh A begins in 2004 x
Long My District begins in 2004 x
Long My Town beings in 2015 x
Phung Hiep begins in 2004 x
Vi Thanh begins in 2004 x
Vi Thuy begins in 2004 x
Cu Lao Dung begins in 2003 x
Nga Nam begins in 2004 x

need to delete when updated district code.y is 61 and ENGTYPE2 is District --> not working

create a unique name for the districts in each province

## Base Model (based on code from Josh)
```{r}
###############################################################

#Model Fitting

###############################################################

# default of burnin = 10000, n.sample = 110000, thin = 10

results<-ST.CARar(m_DHF_cases ~ 1, data = base_model_2001_2006_1,

                  family = "poisson",

                  W = neighb.mat_2,

                  burnin = 10, 

                  n.sample = 100,

                  thin = 5,

                  prior.mean.beta = rep(0,

                                        times = 1),

                  prior.var.beta = rep((100^2),

                                       times = 1),


                  prior.tau2 = c(0.01, 0.01),
                  
                  AR = 1,

                  MALA = TRUE,

                  verbose = TRUE)

results$summary.results

# want to look at the trace plots for seasonality, overall fitted value (probably won't converge with lower numbers of runs)


```


## Tried Running

```{r}
###############################################################

#Model Fitting

###############################################################
library(CARBayesST)
length(base_model_2001_2006$m_DHF_cases)
length(base_model_2001_2006$month)
length(x_model$m_DHF_cases)
length(neighb.mat)

results<-ST.CARar(m_DHF_cases ~ as.factor(month), 
                  data = base_model_2001_2006_1,

                  family = "poisson",

                  W = neighb.mat_2,

                  burnin = 10, 

                  n.sample = 100,

                  thin = 5,

                  prior.mean.beta = rep(0,

                                        times = ncol(base_model_2001_2006_1) - 1),

                  prior.var.beta = rep((100^2),

                                       times = ncol(base_model_2001_2006_1) - 1),


                  prior.tau2 = c(0.01, 0.01),
                  
                  AR = 1,

                  MALA = TRUE,

                  verbose = TRUE)

results$summary.results

# want to look at the trace plots for seasonality, overall fitted value (probably won't converge with lower numbers of runs)

```
Warning in rnorm(n = length(beta.mean), mean = beta.mean, sd = beta.sd) :
  NAs produced
Warning in rnorm(n = N.all, mean = 0, sd = res.sd) : NAs produced
Warning in matrix(offset, nrow = K, ncol = N, byrow = FALSE) :
  data length [54744] is not a sub-multiple or multiple of the number of rows [132]
Warning in matrix(X.standardised %*% beta, nrow = K, ncol = N, byrow = FALSE) :
  data length [54744] is not a sub-multiple or multiple of the number of rows [132]
Warning in matrix(phi, nrow = K, ncol = N, byrow = FALSE) :
  data length [54744] is not a sub-multiple or multiple of the number of rows [132]
Generating 18 post burnin and thinned (if requested) samples.
  |                                                                                 |   0%Warning in rpois(n = n.miss, lambda = fitted[which.miss == 0]) :
  NAs produced
Warning in matrix(Y.DA, nrow = K, ncol = N, byrow = FALSE) :
  data length [54744] is not a sub-multiple or multiple of the number of rows [132]
Warning in matrix(X.standardised %*% beta, nrow = K, ncol = N, byrow = FALSE) :
  data length [54744] is not a sub-multiple or multiple of the number of rows [132]
Warning in rgamma(1, tau2.shape, scale = (1/tau2.scale)) : NAs produced
Error in if (prob > runif(1)) { : missing value where TRUE/FALSE needed