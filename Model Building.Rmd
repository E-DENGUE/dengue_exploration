---
title: "Model Building"
author: "Elisabeth Nelson"
date: "2022-10-20"
output: pdf_document
---
## Load Packages
```{r}
#library(rjags)
library(MCMCpack)
library(stats)
library(CARBayes) # <- this is the package for the model
library(rgdal) # <- for working with shapefiles
library(RColorBrewer) 
library(ggplot2)
library(rgeos) # <- also for working with shapefiles
library(maptools) # shapefiles again
library(spdep) # still shapefiles 
library(ggmap) # plotting shapefiles 
library(sf)
library(dplyr)
library(tidyverse)
library(CARBayesST)
library(TSDT)
library(lubridate)

# parallel processing
## figure out which packages are needed
# state data frame being input
# call jags would be mod_func
# n_advance --> look up do function
# look up what collect does
# likely stored in a list of fitted model outputs
# try talkin gto help desk about cluster

# try running it once 

```


## Set-up for Carbays
```{r}
# Number of spatial units (e.g., districts in MDR)
n.district <- 134
n.district2 <- 132

# Create an n x􏰀 n identity matrix
Id.mat <- diag(n.district)
Id.mat2 <- diag(n.district2)

MDR_2 <- st_read(dsn = '/Users/zoe/Documents/Yale EMD/Rotation 1/Dengue - Vietnam/dengue_exploration/Data/MDR Updated map/VMD_districts_2022.shp')

MDR_3 <- MDR_2 %>%
  filter(VARNAME_2 != "Kien Hai", 
         VARNAME_2 != "Phu Quoc")
```

## Neighbor Matrix
```{r}
# Neighbors can either be Queen (any zip that touches another zip - even at 
# corners) or Rook neighbors (share full sides -- not corners)

# The snap dist is governing the NA in neighbor matrix
# Can remove SNAP statement; if Queen = F then single point touch not allowed 
# and Rook distance used.

# When data is missing -- there's more non-zero links involved 
# Try to make snap distance as small as possible while making sure all states 
# have at least one neighbor
neighb <- poly2nb(MDR_2, queen = T, snap = sqrt(0.001))


# Check average number of links -- increase snap distance if it says there is 
# a zip with zero neighbors
neighb # Avg Number of links = 5.19403 
  # regions 74 nand 76 have no links --> islands Kien Hai/District + Phu Quoc/City


# Make neighbor matrix 
# if zero.policy FALSE stop with error for any empty neighbour sets, 
# if TRUE permit the weights list to be formed with zero-length weights vectors
# B is the basic binary coding, W is row standardised (both are commonly used)
neighb.mat <- nb2mat(neighb, zero.policy = T, style = 'B')


# the islands will not have neighbors, so need to exclude it at first (islands Kien Hai/District + Phu Quoc/City)
neighb2 <- poly2nb(MDR_3, queen = T, snap = sqrt(0.001))
neighb2
neighb.mat_2 <- nb2mat(neighb2, zero.policy = T, style = 'B')


# For Leroux model, neighbor matrix needs to have 0 if not neighboring, -1 if 
# neighbor, and # of neighbors for each state on diagonal), so...
w.mat <- ifelse(neighb.mat==1,-1,neighb.mat)
num.neigh <- colSums(neighb.mat) # Count the number of neighbors for each state
for (i in 1:nrow(w.mat)) { # Put the number of neighbors on diagonal
  for (j in 1:ncol(w.mat)) {
    if (i==j) {
      w.mat[i,j] <- num.neigh[i]
    }
  }
}
# w.mat <- array(NA, dim=c(n.stzipcode,n.zipcode,n.countries))
# w.mat[,,1] <- ifelse(neighb.mat==1,-1,neighb.mat) # Replace 1 with -1
# num.neigh <- colSums(neighb.mat) # Count the number of neighbors for each state
# for (i in 1:nrow(w.mat[,,1])) { # Put the number of neighbors on diagonal
#   for (j in 1:ncol(w.mat[,,1])) {
#     if (i==j) {
#       w.mat[i,j,1] <- num.neigh[i]
#     }
#   }
# }


# could eventually define neighbors for the islands based on spatial adjacency/transport
# could also separately analyze them once we have a model and see if it predcits well in them independently

```

## Create an Aggregated DF With Distinct District Names 
```{r}

#write.csv(MDR_Dengue_map, "/Users/zoe/Documents/Yale EMD/Rotation 1/Dengue - Vietnam/dengue_exploration/Data\\MDR_Dengue_map.csv")

# create data frame
base_model_2001_2006_agg <- fortify(MDR_Dengue_map) 

base_model_2001_2006_agg_2 <- base_model_2001_2006_agg %>%
  filter(NAME_1 == "An Giang" & VARNAME_2 == "Chau Thanh") %>%
  mutate(VARNAME_2 = str_replace(VARNAME_2, "Chau Thanh", "Chau Thanh An Giang"))

base_model_2001_2006_agg_3 <- base_model_2001_2006_agg %>%
  filter(NAME_1 == "Bến Tre" & VARNAME_2 == "Chau Thanh") %>%
  mutate(VARNAME_2 = str_replace(VARNAME_2, "Chau Thanh", "Chau Thanh Ben Tre"))

base_model_2001_2006_agg_4 <- base_model_2001_2006_agg %>%
  filter(NAME_1 == "Đồng Tháp" & VARNAME_2 == "Chau Thanh") %>%
  mutate(VARNAME_2 = str_replace(VARNAME_2, "Chau Thanh", "Chau Thanh Dong Thanp"))

base_model_2001_2006_agg_5 <- base_model_2001_2006_agg %>%
  filter(NAME_1 == "Hậu Giang" & VARNAME_2 == "Chau Thanh") %>%
  mutate(VARNAME_2 = str_replace(VARNAME_2, "Chau Thanh", "Chau Thanh Hau Giang"))

base_model_2001_2006_agg_6 <- base_model_2001_2006_agg %>%
  filter(NAME_1 == "Kiên Giang" & VARNAME_2 == "Chau Thanh") %>%
  mutate(VARNAME_2 = str_replace(VARNAME_2, "Chau Thanh", "Chau Thanh Kien Giang"))

base_model_2001_2006_agg_7 <- base_model_2001_2006_agg %>%
  filter(NAME_1 == "Long An" & VARNAME_2 == "Chau Thanh") %>%
  mutate(VARNAME_2 = str_replace(VARNAME_2, "Chau Thanh", "Chau Thanh Long An"))
 
base_model_2001_2006_agg_8 <- base_model_2001_2006_agg %>%
  filter(NAME_1 == "Sóc Trăng" & VARNAME_2 == "Chau Thanh") %>%
  mutate(VARNAME_2 = str_replace(VARNAME_2, "Chau Thanh", "Chau Thanh Soc Trang")) 
         
base_model_2001_2006_agg_9 <- base_model_2001_2006_agg %>%
  filter(NAME_1 == "Tiền Giang" & VARNAME_2 == "Chau Thanh") %>%
  mutate(VARNAME_2 = str_replace(VARNAME_2, "Chau Thanh", "Chau Thanh Tien Giang"))

base_model_2001_2006_agg_10 <- base_model_2001_2006_agg %>%
  filter(NAME_1 == "Trà Vinh" & VARNAME_2 == "Chau Thanh") %>%
  mutate(VARNAME_2 = str_replace(VARNAME_2, "Chau Thanh", "Chau Thanh Tra Vinh"))

base_model_2001_2006_agg_11 <- base_model_2001_2006_agg %>%
  filter(NAME_1 == "An Giang" & VARNAME_2 == "Phu Tan") %>%
  mutate(VARNAME_2 = str_replace(VARNAME_2, "Phu Tan", "Phu Tan An Giang")) 
      
base_model_2001_2006_agg_12 <- base_model_2001_2006_agg %>%
  filter(NAME_1 == "Cà Mau" & VARNAME_2 == "Phu Tan") %>%
  mutate(VARNAME_2 = str_replace(VARNAME_2, "Phu Tan", "Phu Tan Ca Mau"))

base_model_2001_2006_agg_13 <- base_model_2001_2006_agg %>%
  filter(NAME_1 == "Đồng Tháp" & VARNAME_2 == "Cao Lanh" & district == "cao lãnh") %>%
  mutate(VARNAME_2 = str_replace(VARNAME_2, "Cao Lanh", "Cao Lanh District"))

base_model_2001_2006_agg_14 <- base_model_2001_2006_agg %>%
  filter(NAME_1 == "Đồng Tháp" & VARNAME_2 == "Cao Lanh" & ENGTYPE_2 == "City") %>%
  mutate(VARNAME_2 = str_replace(VARNAME_2, "Cao Lanh", "Cao Lanh City"))

base_model_2001_2006_agg_15 <- base_model_2001_2006_agg %>%
  filter(NAME_1 == "Đồng Tháp" & VARNAME_2 == "Hong Ngu" & district == "hồng ngự") %>%
  mutate(VARNAME_2 = str_replace(VARNAME_2, "Hong Ngu", "Hong Ngu District"))

base_model_2001_2006_agg_16 <- base_model_2001_2006_agg %>%
  filter(NAME_1 == "Đồng Tháp" & VARNAME_2 == "Hong Ngu" & ENGTYPE_2 == "City") %>%
  mutate(VARNAME_2 = str_replace(VARNAME_2, "Hong Ngu", "Hong Ngu City"))

base_model_2001_2006_agg_17 <- base_model_2001_2006_agg %>%
  filter(NAME_1 == "Hậu Giang" & VARNAME_2 == "Long My" & district == "long mỹ") %>%
  mutate(VARNAME_2 = str_replace(VARNAME_2, "Long My", "Long My District"))

base_model_2001_2006_agg_18 <- base_model_2001_2006_agg %>%
  filter(NAME_1 == "Hậu Giang" & VARNAME_2 == "Long My" & ENGTYPE_2 == "Town") %>%
  mutate(VARNAME_2 = str_replace(VARNAME_2, "Long My", "Long My Town"))

base_model_2001_2006_agg_19 <- base_model_2001_2006_agg %>%
  filter(NAME_1 == "Tiền Giang" & VARNAME_2 == "Cai Lay" & district == "cai lậy") %>%
  mutate(VARNAME_2 = str_replace(VARNAME_2, "Cai Lay", "Cai Lay District"))

base_model_2001_2006_agg_20 <- base_model_2001_2006_agg %>%
  filter(NAME_1 == "Tiền Giang" & VARNAME_2 == "Cai Lay" & ENGTYPE_2 == "Town") %>%
  mutate(VARNAME_2 = str_replace(VARNAME_2, "Cai Lay", "Cai Lay Town"))

base_model_2001_2006_agg_21 <- base_model_2001_2006_agg %>%
  filter(NAME_1 == "Trà Vinh" & VARNAME_2 == "Duyen Hai" & district == "duyên hải") %>%
  mutate(VARNAME_2 = str_replace(VARNAME_2, "Duyen Hai", "Duyen Hai District"))

base_model_2001_2006_agg_22 <- base_model_2001_2006_agg %>%
  filter(NAME_1 == "Trà Vinh" & VARNAME_2 == "Duyen Hai" & ENGTYPE_2 == "Town") %>%
  mutate(VARNAME_2 = str_replace(VARNAME_2, "Duyen Hai", "Duyen Hai Town"))

base_model_2001_2006_agg_filter <- rbind(base_model_2001_2006_agg, base_model_2001_2006_agg_2, base_model_2001_2006_agg_3, base_model_2001_2006_agg_4, base_model_2001_2006_agg_5, base_model_2001_2006_agg_6, base_model_2001_2006_agg_7, base_model_2001_2006_agg_8, base_model_2001_2006_agg_9, base_model_2001_2006_agg_10, base_model_2001_2006_agg_11, base_model_2001_2006_agg_12, base_model_2001_2006_agg_13, base_model_2001_2006_agg_14, base_model_2001_2006_agg_15, base_model_2001_2006_agg_16, base_model_2001_2006_agg_17, base_model_2001_2006_agg_18, base_model_2001_2006_agg_19, base_model_2001_2006_agg_20, base_model_2001_2006_agg_21, base_model_2001_2006_agg_22)

names_to_delete <- c("Chau Thanh", "Phu Tan", "Cao Lanh", "Hong Ngu", "Long My", "Cai Lay", "Duyen Hai")

base_model_2001_2006_agg_filter <- base_model_2001_2006_agg_filter %>%
  filter(!(VARNAME_2 %in% names_to_delete))

# rotate month variables into one column
base_model_2001_2006_filter_long <- base_model_2001_2006_agg_filter %>%
  pivot_longer(cols = starts_with("m"), 
               values_to = "m_DHF_cases", 
               names_to = "month")

# fill-in missing years
agg1 <- base_model_2001_2006_filter_long %>%
  #bind_rows() %>% 
  #group_by(VARNAME_2, year, month) %>%
  #summarize(m_DHF_cases = n())  %>%
  #ungroup  %>%
  mutate(month=as.factor(month),
 year=as.factor(year),
 district =as.factor(VARNAME_2)) %>%
  tidyr::complete(year, month, VARNAME_2, fill=list(m_DHF_cases=NA)) #fills NA

base_model_final <- agg1 %>%
  mutate(month = as.numeric(month),
    m_DHF_cases = as.numeric(m_DHF_cases))


```

## Test to make sure data is ready for model (should all be the same number)
```{r}
for(j in 1: length(unique(base_model_2001_2006_agg_filter$VARNAME_2))){
  print(sum(base_model_2001_2006_agg_filter$VARNAME_2 == unique(base_model_2001_2006_agg_filter$VARNAME_2)[j]))
  if( sum(base_model_2001_2006_agg_filter$VARNAME_2 == unique(base_model_2001_2006_agg_filter$VARNAME_2)[j]) != 18) {
    print(unique(base_model_2001_2006_agg_filter$VARNAME_2)[j])
  }
}



```

## Function for generating dataset
```{r}

#initially, fit htough nov 2006, set dec 2006 to NA
#'2006-12-01'


advance_missing_func <- function(N_advance){
      
      base_model_for_model_1 <- base_model_final %>% 
        mutate(year = unfactor(year),
               #monthN = as.numeric(gsub('m','', month)),
               date = as.Date(paste(year, month, '01', sep='-')),
               pop=if_else(is.na(pop), 0.5 ,pop)) %>%
        filter( date <= (as.Date('2006-12-01' ) %m+% months(N_advance) )) %>%
        arrange(district, date) %>%
        group_by(district) %>%
        mutate( m_DHF_cases=if_else(is.na(m_DHF_cases),0, m_DHF_cases), ##ALERT...assuming nov, dec missing=0
          index= row_number() , 
               m_DHF_cases_fit = if_else(index==max(index,na.rm=T), NA_real_,m_DHF_cases) ) %>%
        filter(VARNAME_2 != "Kien Hai", 
         VARNAME_2 != "Phu Quoc") %>%
        dplyr::select(month, year, district, m_DHF_cases,m_DHF_cases_fit, pop)
}

ds <- advance_missing_func(0)
#ds.advance <- lapply(0:10, advance_missing_func)
```


## Base Model (based on code from Josh)
```{r}
###############################################################

#Model Fitting

###############################################################

# default of burnin = 10000, n.sample = 110000, thin = 10

mod.func <- function(N_advance) {
  ds <- advance_missing_func(N_advance) 
 
  x_model = model.matrix(~ as.factor(as.numeric(month)), data = ds)

  offset_model = log(ds$pop)


  results<-ST.CARar(m_DHF_cases_fit ~ -1 + x_model + offset(offset_model) , 
                  data = ds,

                  family = "poisson",

                  W = neighb.mat_2,

                  burnin = 5000, 

                  n.sample = 110000,

                  thin = 10,

                  prior.mean.beta = rep(0,

                                        times = ncol(x_model)),
                                        
                  prior.var.beta = rep((100^2),

                                       times = ncol(x_model)),

                  prior.tau2 = c(0.10, 0.10),
                  
                  AR = 1,

                  MALA = TRUE,

                  verbose = TRUE)
}

mod1_2 <- mod.func(0)


mod1$summary.results

print(mod1)
mod1_2$

# want to look at the trace plots for seasonality, overall fitted value (probably won't converge with lower numbers of runs)

######### plot of betas
beta_samples <-mod1$samples$beta
plot(beta_samples[1,], type='l', col='red',main="beta") # First chain
lines(beta_samples[2,],col='blue')
lines(beta_samples[3,], col = "green")
lines(beta_samples[4,], col = "orange")
lines(beta_samples[5,], col = "yellow")
lines(beta_samples[6,], col = "purple")
lines(beta_samples[7,], col = "firebrick1")
lines(beta_samples[8,], col = "dodgerblue1")
lines(beta_samples[9,], col = "darkolivegreen1")
lines(beta_samples[10,], col = "darkorange3")
lines(beta_samples[11,], col = "goldenrod2")
lines(beta_samples[12,], col = "darkorchid1")

betas <- data.frame(m1 = mod1$samples$beta[,1], m2 = mod1$samples$beta[,2], m3 = mod1$samples$beta[,3], 
                    m4 = mod1$samples$beta[,4], m5 = mod1$samples$beta[,5], m6 = mod1$samples$beta[,6], 
                    m7 = mod1$samples$beta[,7], m8 = mod1$samples$beta[,8], m9 = mod1$samples$beta[,9], 
                    m10 = mod1$samples$beta[,10], m11 = mod1$samples$beta[,11], m12 = mod1$samples$beta[,12])
library(ggplot2)
library(viridis)
library(dplyr)
ggplot(betas)+
  geom_density(aes(betas[,1]), fill = 'red', color = 'red')+
  geom_density(aes(betas[,2]), fill = 'blue', color = 'blue')+
  geom_density(aes(betas[,3]), fill = 'green', color = 'green')+
  geom_density(aes(betas[,4]), fill = 'orange', color = 'orange')+
  geom_density(aes(betas[,5]), fill = 'yellow', color = 'yellow')+
  geom_density(aes(betas[,6]), fill = 'purple', color = 'purple')+
  geom_density(aes(betas[,7]), fill = 'firebrick1', color = 'firebrick1')+
  geom_density(aes(betas[,8]), fill = 'dodgerblue1', color = 'dodgerblue1')+
  geom_density(aes(betas[,9]), fill = 'darkolivegreen1', color = 'darkolivegreen1')+
  geom_density(aes(betas[,10]), fill = 'darkorange3', color = 'darkorange3')+
  geom_density(aes(betas[,11]), fill = 'goldenrod2', color = 'goldenrod2')+
  geom_density(aes(betas[,12]), fill = 'darkorchid1', color = 'darkorchid1')+
  geom_vline(xintercept = 1, color = "red", size = 1.5)+
   labs(title = "Posterior distribution of the month coefficients", x = "Beta", y = "Density")

## check residuals
ds_for_plots <- ds %>%
  ungroup() %>%
  mutate(resid = mod1$residuals$response,
         fitted = mod1$fitted.values) %>%
  group_by(district)

par(mfrow = c(1,2))
ggplot(data = ds_for_plots)+
  geom_line(aes(month, m_DHF_cases_fit, color = district))+
  theme(legend.position = "none")
ggplot(data = ds_for_plots)+
  geom_line(aes(month, fitted, color = district))+
  theme(legend.position = "none")

ds_for_plots %>%
  filter(month == 12) %>%
  ungroup() %>%
  ggplot()+
  geom_point(aes(district, m_DHF_cases_fit), color = "blue")+
  geom_point(aes(district, fitted), color = "red")


ds_for_plots %>%
  ggplot(aes(fill = resid))+
  geom_sf()+
  scale_fill_viridis(option = "viridis", direction = -1, name = "Residuals")

```
Should we be using our past model as the next model's prior?

Setting up the model.
Generating 10900 post burnin and thinned (if requested) samples.
  |================================================================================                 |  82%Warning: NAs producedWarning: NAs producedWarning: NAs producedWarning: NAs produced
  Error in if (prob > runif(1)) { : missing value where TRUE/FALSE needed
  
```{r}
base_model_final %>%
  filter(year < 2007) %>%
  ggplot()+
  geom_line(aes(month, m_DHF_cases), col = "red")+
  geom_line(aes(month, fitted.values), data = mod1)

new_model <- base_model_final %>%
  dplyr::filter(year == 2001 | year == 2002 | year == 2003 | year == 2004 | year == 2005 | year == 2006) 


x_val <- c(1:length(mod1$fitted.values))
x_val_2 <- c(1:length(new_model$m_DHF_cases))

par(mfrow = c(1, 2))
plot(x_val, mod1$fitted.values, type = "l")
plot(x_val_2, new_model$m_DHF_cases, type = "l")

```
