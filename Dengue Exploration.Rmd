---
title: "Dengue Data Exploration"
author: "Elisabeth Nelson"
date: "2022-10-02"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# set the libraries
library(dplyr)
library(readr)
library(readxl)
library(ggplot2)
library(maptools)
library(spdep)
library(rgeos)
library(sp)
library(MASS)
library(surveillance)
library(tidyr)
library(splines)
library(tidyverse)
library(tsibble)
library(sf)
library(scales)
library(RColorBrewer)
library(viridis)

```


## Import the Data and Combine Incidence and Population Data
```{r}
# import the data
library(readxl)
MDR_Dengue_Cases <- read_excel("~/Documents/Yale EMD/Rotation 1/Dengue - Vietnam/dengue_exploration/Data/CONFIDENTIAL/MDR Dengue Cases.xlsx")
MDR_district_cases_pop <- read_excel("~/Documents/Yale EMD/Rotation 1/Dengue - Vietnam/dengue_exploration/Data/CONFIDENTIAL/updated - MDR district dengue cases & population.xlsx", 
    sheet = "pop")

# rename columns and change variable structures
MDR_district_cases_pop <- MDR_district_cases_pop %>%
  rename('no_symbols_name' = 'District') %>%
  rename('old_district_code' = 'District code - Old MDR map') %>%
  rename('updated_district_code' = 'District code - Updated MDR map') %>%
  mutate(Province = str_replace(Province, "Can Tho city", "Can Tho")) %>%
  mutate(no_symbols_name = tolower(no_symbols_name),
         symbols_name = tolower(symbols_name))

MDR_Dengue_Cases <- MDR_Dengue_Cases %>%
  mutate(district = tolower(district)) %>%
  mutate(district = str_replace(district, "h. vĩnh lợi", "vĩnh lợi")) %>%
  mutate(district = str_replace(district, "mỏ cày/mỏ cày nam", "mỏ cày nam")) %>%
  mutate(district = str_replace(district, "tx. cao lãnh", "tp. cao lãnh")) %>%
  mutate(district = str_replace(district, "tiểu cần", "tiêu cần"))
 

  

updated_MDR_Dengue_Cases <- left_join(MDR_Dengue_Cases, MDR_district_cases_pop, by = c("district" = "symbols_name"), na.rm = na.rm)

# fixed mo cay district --> combine populations of mo cay nam and mo cay bac based on updated district codes
# fixed cần thơ not --> combine Binh Thuy, Co Do, Cai Rang, Ninh Kieu, Phong Dien, Thoi Lai based on updated district codes 

str(updated_MDR_Dengue_Cases)


```

## Changing the District Names
Key for types of districts:
Huyen = District

Thanh pho = City
Chau Doc, Long Xuyen, Bac Lieu, Ben Tre, Ca Mau, Thanh Pho Cao Lanh, Thi xa Hong Ngu, Sa Dec, Nga Bay, Vi Thanh, Ha Tien, Phu Quoc, Rach Gia, Tan An, Soc Trang, My Tho, Tra Vinh, Vinh Long

Thi xa = Town
Tan Chau, Gia Rai, Long My town, Kien Tuong, Nga Nam, Vinh Chau, Thi xa Cai Lay, Go Cong, Duyen Hai town, Binh Minh

Quan = Urban District 
Binh Thuy, Cai Rang, Ninh Kieu, O Mon, Thot Not

```{r}
# Create a column with district names matching VARNAME_2
  
updated_MDR_Dengue_Cases <- updated_MDR_Dengue_Cases %>%
  mutate(no_symbols_name = str_replace(no_symbols_name, "thanh pho cao lanh" , "cao lanh")) %>%
  mutate(no_symbols_name = str_replace(no_symbols_name, "thi xa hong ngu", "hong ngu")) %>%
  mutate(no_symbols_name = str_replace(no_symbols_name, "thi xa cai lay", "cai lay")) %>%
  mutate(no_symbols_name = str_replace(no_symbols_name, "huyen cao lanh", "cao lanh")) %>%
  mutate(no_symbols_name = str_replace(no_symbols_name, "huyen hong ngu", "hong ngu")) %>%
  mutate(no_symbols_name = str_replace(no_symbols_name, "huyen cai lay", "cai lay")) %>%
  mutate(no_symbols_name = str_replace(no_symbols_name, "duyen hai town", "duyen hai")) %>%
  mutate(no_symbols_name = str_replace(no_symbols_name, "long my town", "long my"))

# Types of Districts
City <- c("chau doc", "long xuyen", "bac lieu", "ben tre", "ca mau", "thanh pho cao lanh", "thi xa hong ngu", "sa dec", "nga bay", "vi thanh", "ha tien", "phu quoc", "rach gia", "tan an", "soc trang", "my tho", "tra vinh", "vinh long")
Town <- c("tan chau", "gia rai", "long my town", "kien tuong", "nga nam", "vinh chau", "thi xa cai lay", "go cong", "duyen hai town", "binh minh")
Urban_District <- c("binh thuy", "cai rang", "ninh kieu", "o mon", "thot not")
District <- updated_MDR_Dengue_Cases$no_symbols_name 
District <- District[!District %in% City]
District <- District[!District %in% Town]
District <- District[!District %in% Urban_District]


# Create a column with district types matching ENGTYPE_2

updated_MDR_Dengue_Cases <- updated_MDR_Dengue_Cases %>%
  mutate(district_type = case_when(
    no_symbols_name %in% City ~ "city", 
    no_symbols_name %in% Town ~ "town", 
    no_symbols_name %in% Urban_District ~ "urban district", 
    no_symbols_name %in% District ~ "district"
  )) 


  


```

## Continue Cleaning
```{r}

# fix the NA for Tan An, for some reason was given the name Ben Luc when coded without symbols, also fix Cai Lay and An Phu
updated_MDR_Dengue_Cases$no_symbols_name[updated_MDR_Dengue_Cases$district == "tân an" & updated_MDR_Dengue_Cases$no_symbols_name ==  "ben luc"] <- "tan an"
updated_MDR_Dengue_Cases$no_symbols_name[updated_MDR_Dengue_Cases$district == "tân an" & updated_MDR_Dengue_Cases$no_symbols_name ==  "ben luc"] <- "tan an"
# need to run again to fix Tan An
updated_MDR_Dengue_Cases <- updated_MDR_Dengue_Cases %>%
  mutate(district_type = case_when(
    no_symbols_name %in% City ~ "city", 
    no_symbols_name %in% Town ~ "town", 
    no_symbols_name %in% Urban_District ~ "urban district", 
    no_symbols_name %in% District ~ "district"
  )) 

# create incidence per 100,000 people column
updated_MDR_Dengue_Cases <- updated_MDR_Dengue_Cases %>%
  mutate(DHF_incidence = 100000*(total_DHF_cases/pop)) %>%
  mutate(log_DHF_incidence = log(DHF_incidence)) %>%
  mutate(m1 = as.numeric(m1), 
         m2 = as.numeric(m2),
         m3 = as.numeric(m3), 
         m4 = as.numeric(m4), 
         m5 = as.numeric(m5), 
         m6 = as.numeric(m6))

# create a monthly incidence df
updated_monthly_DHF_incidence <- updated_MDR_Dengue_Cases %>%
  dplyr::select(c(district, district_code, province, total_DHF_cases, year, m1, m2, m3, m4, m5, m6, m7, m8, m9, m10, m11, m12, no_symbols_name, district_type, updated_district_code.y, pop)) %>%
    pivot_longer(cols = starts_with("m"), 
               values_to = "m_DHF_cases", 
               names_to = "monthvar") %>%
  mutate(m_DHF_incidence = 100000*(m_DHF_cases/pop), 
         log_m_DHF_incidence = log(m_DHF_incidence))

```


## An Giang Province
```{r}

an_giang_cases_by_year <- updated_MDR_Dengue_Cases %>%
  filter(province == "An Giang") %>%
  group_by(year) %>%
  summarize(year_total = sum(total_DHF_cases))

an_giang_cases_by_year %>%
  ggplot(aes(x = year, y = year_total))+
  geom_bar(stat = "identity")+
  geom_jitter(width = 0.15)+
  theme(axis.text.x = element_text(angle = 90))+
  labs(title = "An Giang Province DHF Cases 2001 - 2018", x = "Year", y = "Total DHF Cases")

# look at time series
an_giang_cases <- updated_MDR_Dengue_Cases %>%
  filter(province == "An Giang")

ggplot(an_giang_cases, aes(x = year, y = total_DHF_cases, group=district, col = district))+
  geom_line()+
  theme_classic()
```

## Bac Lieu Province
```{r}

bac_lieu_cases_by_year <- updated_MDR_Dengue_Cases %>%
  filter(province == "Bac Lieu") %>%
  group_by(year) %>%
  summarize(year_total = sum(total_DHF_cases))
  
bac_lieu_cases_by_year %>%
  ggplot(aes(x = year, y = year_total))+
  geom_bar(stat = "identity")+
  geom_jitter(width = 0.15)+
  theme(axis.text.x = element_text(angle = 90))+
  labs(title = "Bac Lieu Province DHF Cases 2001 - 2018", x = "Year", y = "Total DHF Cases")
  
# look at time series
bac_lieu_cases <- updated_MDR_Dengue_Cases %>%
  filter(province == "Bac Lieu")

ggplot(bac_lieu_cases, aes(x = year, y = total_DHF_cases, group=district, col = district))+
  geom_line()+
  theme_classic()

```
## Ben Tre Province
```{r}

ben_tre_cases_by_year <- updated_MDR_Dengue_Cases %>%
  filter(province == "Ben Tre") %>%
  group_by(year) %>%
  summarize(year_total = sum(total_DHF_cases))
  
ben_tre_cases_by_year %>%
  ggplot(aes(x = year, y = year_total))+
  geom_bar(stat = "identity")+
  geom_jitter(width = 0.15)+
  theme(axis.text.x = element_text(angle = 90))+
  labs(title = "Ben Tre Province DHF Cases 2001 - 2018", x = "Year", y = "Total DHF Cases")

# look at time series
ben_tre_cases <- updated_MDR_Dengue_Cases %>%
  filter(province == "Ben Tre")

ggplot(ben_tre_cases, aes(x = year, y = total_DHF_cases, group=district, col = district))+
  geom_line()+
  theme_classic()

```
## Ca Mau Province
```{r}

ca_mau_cases_by_year <- updated_MDR_Dengue_Cases %>%
  filter(province == "Ca Mau") %>%
  group_by(year) %>%
  summarize(year_total = sum(total_DHF_cases))
  
ca_mau_cases_by_year %>%
  ggplot(aes(x = year, y = year_total))+
  geom_bar(stat = "identity")+
  geom_jitter(width = 0.15)+
  theme(axis.text.x = element_text(angle = 90))+
  labs(title = "Ca Mau Province DHF Cases 2001 - 2018", x = "Year", y = "Total DHF Cases")

# look at time series
ca_mau_cases <- updated_MDR_Dengue_Cases %>%
  filter(province == "Ca Mau")

ggplot(ca_mau_cases, aes(x = year, y = total_DHF_cases, group=district, col = district))+
  geom_line()+
  theme_classic()
```

## Can Tho Province
```{r}

can_tho_cases_by_year <- updated_MDR_Dengue_Cases %>%
  filter(province == "Can Tho") %>%
  group_by(year) %>%
  summarize(year_total = sum(total_DHF_cases))
  
can_tho_cases_by_year %>%
  ggplot(aes(x = year, y = year_total))+
  geom_bar(stat = "identity")+
  geom_jitter(width = 0.15)+
  theme(axis.text.x = element_text(angle = 90))+
  labs(title = "Can Tho Province DHF Cases 2001 - 2018", x = "Year", y = "Total DHF Cases")

# look at time series
can_tho_cases <- updated_MDR_Dengue_Cases %>%
  filter(province == "Can Tho")

ggplot(can_tho_cases, aes(x = year, y = total_DHF_cases, group=district, col = district))+
  geom_line()+
  theme_classic()

#### weird jump just before 2005
```

## Dong Thap Province
```{r}

dong_thap_cases_by_year <- updated_MDR_Dengue_Cases %>%
  filter(province == "Dong Thap") %>%
  group_by(year) %>%
  summarize(year_total = sum(total_DHF_cases))
  
dong_thap_cases_by_year %>%
  ggplot(aes(x = year, y = year_total))+
  geom_bar(stat = "identity")+
  geom_jitter(width = 0.15)+
  theme(axis.text.x = element_text(angle = 90))+
  labs(title = "Dong Thap Province DHF Cases 2001 - 2018", x = "Year", y = "Total DHF Cases")

# look at time series
dong_thap_cases <- updated_MDR_Dengue_Cases %>%
  filter(province == "Dong Thap")

ggplot(dong_thap_cases, aes(x = year, y = total_DHF_cases, group=district, col = district))+
  geom_line()+
  theme_classic()

```

## Hau Giang Province
```{r}

hau_giang_cases_by_year <- updated_MDR_Dengue_Cases %>%
  filter(province == "Hau Giang") %>%
  group_by(year) %>%
  summarize(year_total = sum(total_DHF_cases))
  
hau_giang_cases_by_year %>%
  ggplot(aes(x = year, y = year_total))+
  geom_bar(stat = "identity")+
  geom_jitter(width = 0.15)+
  theme(axis.text.x = element_text(angle = 90))+
  labs(title = "Hau Giang Province DHF Cases 2004 - 2018", x = "Year", y = "Total DHF Cases")

# look at time series
hau_giang_cases <- updated_MDR_Dengue_Cases %>%
  filter(province == "Hau Giang")

ggplot(hau_giang_cases, aes(x = year, y = total_DHF_cases, group=district, col = district))+
  geom_line()+
  theme_classic()
```

## Kien Giang Province
```{r}

kien_giang_cases_by_year <- updated_MDR_Dengue_Cases %>%
  filter(province == "Kien Giang") %>%
  group_by(year) %>%
  summarize(year_total = sum(total_DHF_cases))
  
kien_giang_cases_by_year %>%
  ggplot(aes(x = year, y = year_total))+
  geom_bar(stat = "identity")+
  geom_jitter(width = 0.15)+
  theme(axis.text.x = element_text(angle = 90))+
  labs(title = "Kien Giang Province DHF Cases 2001 - 2018", x = "Year", y = "Total DHF Cases")

# look at time series
kien_giang_cases <- updated_MDR_Dengue_Cases %>%
  filter(province == "Kien Giang")

ggplot(kien_giang_cases, aes(x = year, y = total_DHF_cases, group=district, col = district))+
  geom_line()+
  theme_classic()

```

## Long An Province
```{r}

long_an_cases_by_year <- updated_MDR_Dengue_Cases %>%
  filter(province == "Long An") %>%
  group_by(year) %>%
  summarize(year_total = sum(total_DHF_cases))
  
long_an_cases_by_year %>%
  ggplot(aes(x = year, y = year_total))+
  geom_bar(stat = "identity")+
  geom_jitter(width = 0.15)+
  theme(axis.text.x = element_text(angle = 90))+
  labs(title = "Long An Province DHF Cases 2001 - 2018", x = "Year", y = "Total DHF Cases")

# look at time series
long_an_cases <- updated_MDR_Dengue_Cases %>%
  filter(province == "Long An")

ggplot(long_an_cases, aes(x = year, y = total_DHF_cases, group=district, col = district))+
  geom_line()+
  theme_classic()

```

## Soc Trang Province
```{r}

soc_trang_cases_by_year <- updated_MDR_Dengue_Cases %>%
  filter(province == "Soc Trang") %>%
  group_by(year) %>%
  summarize(year_total = sum(total_DHF_cases))
  
soc_trang_cases_by_year %>%
  ggplot(aes(x = year, y = year_total))+
  geom_bar(stat = "identity")+
  geom_jitter(width = 0.15)+
  theme(axis.text.x = element_text(angle = 90))+
  labs(title = "Soc Trang Province DHF Cases 2001 - 2018", x = "Year", y = "Total DHF Cases")

# look at time series
soc_trang_cases <- updated_MDR_Dengue_Cases %>%
  filter(province == "Soc Trang")

ggplot(soc_trang_cases, aes(x = year, y = total_DHF_cases, group=district, col = district))+
  geom_line()+
  theme_classic()

```

## Tien Giang Province
```{r}

tien_giang_cases_by_year <- updated_MDR_Dengue_Cases%>%
  filter(province == "Tien Giang") %>%
  group_by(year) %>%
  summarize(year_total = sum(total_DHF_cases))
  
tien_giang_cases_by_year %>%
  ggplot(aes(x = year, y = year_total))+
  geom_bar(stat = "identity")+
  geom_jitter(width = 0.15)+
  theme(axis.text.x = element_text(angle = 90))+
  labs(title = "Tien Giang Province DHF Cases 2001 - 2018", x = "Year", y = "Total DHF Cases")

# look at time series
tien_giang_cases <- updated_MDR_Dengue_Cases %>%
  filter(province == "Tien Giang")

ggplot(tien_giang_cases, aes(x = year, y = total_DHF_cases, group=district, col = district))+
  geom_line()+
  theme_classic()

```

## Tra Vinh Province
```{r}

tra_vinh_cases_by_year <- updated_MDR_Dengue_Cases %>%
  filter(province == "Tra Vinh") %>%
  group_by(year) %>%
  summarize(year_total = sum(total_DHF_cases))
  
tra_vinh_cases_by_year %>%
  ggplot(aes(x = year, y = year_total))+
  geom_bar(stat = "identity")+
  geom_jitter(width = 0.15)+
  theme(axis.text.x = element_text(angle = 90))+
  labs(title = "Tra Vinh Province DHF Cases 2001 - 2018", x = "Year", y = "Total DHF Cases")

# look at time series
tra_vinh_cases <- updated_MDR_Dengue_Cases %>%
  filter(province == "Tra Vinh")

ggplot(tra_vinh_cases, aes(x = year, y = total_DHF_cases, group=district, col = district))+
  geom_line()+
  theme_classic()


```

## Vinh Long Province
```{r}

vinh_long_cases_by_year <- updated_MDR_Dengue_Cases %>%
  filter(province == "Vinh Long") %>%
  group_by(year) %>%
  summarize(year_total = sum(total_DHF_cases))
  
vinh_long_cases_by_year %>%
  ggplot(aes(x = year, y = year_total))+
  geom_bar(stat = "identity")+
  geom_jitter(width = 0.15)+
  theme(axis.text.x = element_text(angle = 90))+
  labs(title = "Vinh Long Province DHF Cases 2001 - 2018", x = "Year", y = "Total DHF Cases")

# look at time series
vinh_long_cases <- updated_MDR_Dengue_Cases %>%
  filter(province == "Vinh Long")

ggplot(vinh_long_cases, aes(x = year, y = total_DHF_cases, group=district, col = district))+
  geom_line()+
  theme_classic()

```

## Time Series 
```{r}
#without splines
#x <- MDR_Dengue_Cases$year
#y <- MDR_Dengue_Cases$total_DHF_cases
#y.lab <- 'Total Annual DHF Cases'
#x.lab <- 'Year'
#plot(x, y, cex.lab = 1.1, col="darkgrey", xlab = x.lab, ylab = y.lab,
#     main = "", bty = 'l')

#with splines
#library(stats); library(splines); library(gam); library(dlnm)

#fit <- gam::gam(total_DHF_cases ~ year + s(year, 7*18), family = quasipoisson, data = MDR_Dengue_Cases)
#pr <- predict(fit, type = "terms")
#x1 <- seq(as.Date("2001-01-01"), as.Date("2018-12-12"), "year")
#plot(x, pr[, 2], type = "l", lty =2, ylim = range(pr, na.rm = TRUE), ylab = "", xlab = "")

# total DHF cases
ggplot(updated_MDR_Dengue_Cases, aes(x = year, y = total_DHF_cases, group=district, col = province))+
  geom_line()+
  theme_classic()+
  labs(title = "MDR Province Total DHF Cases 2001-2018", x = "Year", y = "Total DHF Cases")

ggplot(updated_MDR_Dengue_Cases, aes(x = year, y = total_DHF_cases, group=district))+
  geom_line()+
  facet_wrap(~province, scales = 'free_y')+
  theme_classic() +
  labs(title = "MDR Province Total DHF Cases 2001-2018", subtitle = "Grouped by Province", x = "Year", y = "Total DHF Cases")

ggplot(updated_MDR_Dengue_Cases, aes(x = year, y = total_DHF_cases, group=district, col = province))+
  geom_line()+
  facet_wrap(~factor(district_type), scales = 'free_y')+
  theme_classic()+
  labs(title = "MDR Province Total DHF Cases 2001-2018", subtitle = "Grouped by District Type", x = "Year", y = "Total DHF Cases")

ggplot(updated_monthly_DHF_incidence, aes(x = monthvar, y = m_DHF_cases, group=district, col = province))+
  geom_line()+
  facet_wrap(~factor(year), scales = 'free_y')+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, size = 5))+ 
  labs(title = "MDR Province Total DHF Cases", subtitle = "Grouped by Year", x = "Month", y = "Total DHF Cases")

ggplot(updated_monthly_DHF_incidence, aes(x = year, y = m_DHF_cases, group=district, col = province))+
  geom_line()+
  facet_wrap(~factor(monthvar), scales = 'free_y')+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, size = 5))+ 
  labs(title = "MDR Province Total DHF Cases", subtitle = "Grouped by Month", x = "Year", y = "Total DHF Cases")

# DHF incidence 
ggplot(updated_MDR_Dengue_Cases, aes(x = year, y = DHF_incidence, group=district, col = province))+
  geom_line()+
  theme_classic()+
  labs(title = "MDR Province DHF Incidence 2001-2018", subtitle = "Using current population estimates", x = "Year", y = "DHF Incidence per 100,000 People")

ggplot(updated_MDR_Dengue_Cases, aes(x = year, y = DHF_incidence, group=district))+
  geom_line()+
  facet_wrap(~province, scales = 'free_y')+
  theme_classic() +
  labs(title = "MDR Province DHF Incidence 2001-2018", subtitle = "Grouped by province, using current population estimates", x = "Year", y = "DHF Incidence per 100,000 People")

ggplot(updated_MDR_Dengue_Cases, aes(x = year, y = DHF_incidence, group=district, col = province))+
  geom_line()+
  facet_wrap(~factor(district_type), scales = 'free_y')+
  theme_classic()+
  labs(title = "MDR Province DHF Incidence 2001-2018", subtitle = "Grouped by district type, using current population estimates", x = "Year", y = "DHF Incidence per 100,000 People")

ggplot(updated_monthly_DHF_incidence, aes(x = monthvar, y = m_DHF_incidence, group=district, col = province))+
  geom_line()+
  facet_wrap(~factor(year), scales = 'free_y')+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, size = 5))+ 
  labs(title = "MDR Province DHF Incidence", subtitle = "Grouped by Year", x = "Month", y = "DHF Incidence per 100,000 People")

ggplot(updated_monthly_DHF_incidence, aes(x = year, y = m_DHF_incidence, group=district, col = province))+
  geom_line()+
  facet_wrap(~factor(monthvar), scales = 'free_y')+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, size = 5))+ 
  labs(title = "MDR Province DHF Incidence", subtitle = "Grouped by Month", x = "Year", y = "DHF Incidence per 100,000 People")

```




## Get Province Map
```{r}

#Reading in the Shapefile
#setwd("~/Documents/Yale EMD/Rotation 1/Dengue - Vietnam/OneDrive_1_9-16-2022")

#MA<-readShapeSpatial('./MDR District Map/DBSCL_Ranh gioi_vung_region.shp')  
#plot(MA)


MDR <- readShapeSpatial('/Users/zoe/Documents/Yale EMD/Rotation 1/Dengue - Vietnam/dengue_exploration/Data/MDR Updated map/VMD_districts_2022.shp')
plot(MDR)


MDR@data

```

## Combine Map and Incidence Data
```{r}

MDR_2 <- st_read(dsn = '/Users/zoe/Documents/Yale EMD/Rotation 1/Dengue - Vietnam/dengue_exploration/Data/MDR Updated map/VMD_districts_2022.shp')

MDR@data

MDR_2 %>%
  mutate(MDR_2, VARNAME_2 = as.character(VARNAME_2)) %>%
  mutate(MDR_2, ENGTYPE_2 = as.character(ENGTYPE_2)) 

# re-capitalize district names and types to match with the shapefile
updated_MDR_Dengue_Cases <- updated_MDR_Dengue_Cases %>%
  mutate(no_symbols_name = str_to_title(no_symbols_name), 
         district_type = str_to_title(district_type))
updated_monthly_DHF_incidence <- updated_monthly_DHF_incidence %>%
  mutate(no_symbols_name = str_to_title(no_symbols_name), 
         district_type = str_to_title(district_type))
  
MDR_Dengue_map <- left_join(MDR_2, updated_MDR_Dengue_Cases, by = c("VARNAME_2" = "no_symbols_name", "ENGTYPE_2" = "district_type"))

MDR_monthly_dengue_map <- left_join(MDR_2, updated_monthly_DHF_incidence, by = c("VARNAME_2" = "no_symbols_name", "ENGTYPE_2" = "district_type"))
```

## Map DHF Incidence Data 
```{r}
# total case map
ggplot(data = MDR_Dengue_map)+
  geom_sf(aes(fill = total_DHF_cases), color = "black", size = 0.25)+
  scale_fill_distiller(name = "DHF Cases", 
                       palette = "Blues", 
                       direction = 1,
                       breaks = pretty_breaks())+
   theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_rect(fill = "white", color = NA)) +
  labs(title = "Total DHF Cases in MDR 2001-2018")

# case map with district population included 
st_geometry_type(MDR_Dengue_map, by_geometry=FALSE)
sdcntrd <- st_centroid(MDR_Dengue_map)
st_geometry_type(MDR_Dengue_map, by_geometry = FALSE)

ggplot()+
  geom_sf(data = MDR_Dengue_map, aes(fill = total_DHF_cases), color = "black", size = 0.25)+
  scale_fill_distiller(name = "DHF Cases", 
                       palette = "Blues", 
                       direction = 1,
                       breaks = pretty_breaks())+
  geom_sf(data = sdcntrd, aes(size = pop), color = "black", show.legend = "point")+
  scale_size(name = "Population")+
   theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_rect(fill = "white", color = NA)) +
  labs(title = "Total DHF Cases in MDR 2001-2018")

# incidence map
ggplot(data = MDR_Dengue_map)+
  geom_sf(aes(fill = DHF_incidence), color = "black", size = 0.25)+
  scale_fill_distiller(name = "DHF Incidence per 100,000 people", 
                       palette = "Reds", 
                       direction = 1,
                       breaks = pretty_breaks())+
   theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_rect(fill = "white", color = NA)) +
  labs(title = "DHF Incidence in MDR 2001-2018")

ggplot(data = MDR_Dengue_map)+
  geom_sf(aes(fill = log(DHF_incidence)), color = "black", size = 0.25)+
  scale_fill_distiller(name = "Log DHF Incidence per 100,000 people", 
                       palette = "Reds", 
                       direction = 1,
                       breaks = pretty_breaks())+
   theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_rect(fill = "white", color = NA)) +
  labs(title = "DHF Incidence in MDR 2001-2018")

#incidence maps by year
ggplot(data = MDR_Dengue_map)+
  geom_sf(aes(fill = log(DHF_incidence)), color = "black", size = 0.25)+
  facet_wrap(~factor(year))+
  scale_fill_distiller(name = "Log DHF Incidence per 100,000 people", 
                       palette = "Reds", 
                       direction = 1,
                       breaks = pretty_breaks())+
   theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_rect(fill = "white", color = NA)) +
  labs(title = "DHF Incidence in MDR 2001-2018", subtitle = "Grouped by year")

#incidence maps by month
ggplot(data = MDR_monthly_dengue_map)+
  geom_sf(aes(fill = log(m_DHF_incidence)), color = "black", size = 0.25)+
  facet_wrap(~factor(monthvar))+
  scale_fill_distiller(name = "Log DHF Incidence per 100,000 people", 
                       palette = "Reds", 
                       direction = 1,
                       breaks = pretty_breaks())+
   theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_rect(fill = "white", color = NA)) +
  labs(title = "DHF Incidence in MDR 2001-2018", subtitle = "Grouped by month")


# average of each month by district 
MDR_monthly_average_map <- MDR_Dengue_map %>%
  group_by(factor(VARNAME_2)) %>%
  summarize(m1_avg = mean(m1),
            m2_avg = mean(m2),
            m3_avg = mean(m3),
            m4_avg = mean(m4),
            m5_avg = mean(m5),
            m6_avg = mean(m6),
            m7_avg = mean(m7),
            m8_avg = mean(m8),
            m9_avg = mean(m9),
            m10_avg = mean(m10),
            m11_avg = mean(m11),
            m12_avg = mean(m12))
  
MDR_monthly_average_map <- MDR_monthly_average_map %>%
  pivot_longer(cols = starts_with("m"), 
               values_to = "m_avg_DHF_cases", 
               names_to = "month")

  ggplot(data = MDR_monthly_average_map)+
  geom_sf(aes(fill = m_avg_DHF_cases, na.rm = T), color = "black", size = 0.25)+
  facet_wrap(~factor(month))+
  scale_fill_distiller(name = "DHF Cases", 
                       palette = "Reds", 
                       direction = 1,
                       breaks = pretty_breaks())+
   theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_rect(fill = "white", color = NA)) +
  labs(title = "Average Monthly DHF Cases 2001 - 2018", subtitle = "Grouped by month")
  
  
  # try to turn off borders
  # make sure month 7 has 134 rows
  # and check the number of districts in the map file and the incidence data

  #test
```


## Heat Map
```{r}


MDR_dengue_heatmap <- MDR_Dengue_map %>%
  group_by(VARNAME_2) %>%
  mutate(scaled_cases = total_DHF_cases/max(total_DHF_cases))

MDR_monthly_dengue_heatmap <- MDR_monthly_dengue_map %>%
 group_by(VARNAME_2) %>%
  group_by(monthvar) %>%
  mutate(scaled_cases = m_DHF_cases/max(m_DHF_cases))

# by each district
ggplot(MDR_dengue_heatmap, aes(year, VARNAME_2, fill = scaled_cases))+
  geom_tile()+ 
  scale_fill_distiller(name = "Scaled DHF Cases", 
                       palette = "Blues", 
                       direction = 1,
                       breaks = pretty_breaks())+
  theme(axis.text.y = element_text(size = 3))+
  labs(x = "Year", y = "District", title ="Heatmap of DHF Cases in MDR 2001 - 2018")


# by each province
ggplot(MDR_dengue_heatmap, aes(year, province, fill = scaled_cases))+
  geom_tile() +
  scale_fill_distiller(name = "Scaled DHF Cases", 
                       palette = "Blues", 
                       direction = 1,
                       breaks = pretty_breaks())+
  labs(x = "Year", y = "Province", title = "Heatmap of MDR DHF Cases in MDR 2001 - 2018")

#by each month
ggplot(MDR_monthly_dengue_heatmap, aes(year, monthvar, fill = scaled_cases))+
  geom_tile() +
  labs(x = "Year", y = "Month", title = "Heatmap of MDR DHF Cases")




#MDR_dengue_heatmap_2 <- MDR_dengue_heatmap_2 %>%
#  group_by(VARNAME_2, monthvar) %>%
#  mutate(m_scaled_cases = m_DHF_cases/max(m_DHF_cases))
#p <- ggplot(MDR_dengue_heatmap_2, aes(monthvar, province, fill = m_scaled_cases))+
#      geom_tile(color = "white", size = 0.1)+
#      scale_fill_viridis(name = "Monthly DHF Cases", option = "C")
#p <- p + facet_grid(year)
#p <- p + scale_y_continuous(trans = "reverse", breaks = unique(MDR_dengue_heatmap_2$province))
#p <- p + scale_x_continuous(breaks = c(1:12))
#p <-p + theme_minimal(base_size = 8)
#p <-p + labs(title= paste("Monthly DHF Cases"), x="Month", y="Province")
#p <-p + theme(legend.position = "bottom")+
#  theme(plot.title=element_text(size = 14))+
#  theme(axis.text.y=element_text(size=6)) +
#  theme(strip.background = element_rect(colour="white"))+
#  theme(plot.title=element_text(hjust=0))+
#  theme(axis.ticks=element_blank())+
#  theme(axis.text=element_text(size=7))+
#  theme(legend.title=element_text(size=8))+
#  theme(legend.text=element_text(size=6))
  #removeGrid()
#p



color <- rev(viridis(10))
```


## Incidence maps by year 
```{r}
MDR_dengue_heatmap %>%
  ggplot()+
  geom_sf(aes(fill = scaled_cases), color = "black", size = 0.25)+
  scale_fill_distiller(name = "DHF Cases", 
                       palette = "Reds", 
                       breaks = pretty_breaks())+
  facet_wrap(~year, ncol = 6) +
   theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_rect(fill = "white", color = NA)) +
  labs(title = "Scaled DHF Cases in MDR 2001-2018") 

# 2001
MDR_dengue_heatmap_2001 <- MDR_dengue_heatmap %>%
  filter(year == 2001) 

 ggplot()+
     geom_sf(aes(fill = scaled_cases), color = "black", size = 0.25)+
  scale_fill_distiller(name = "DHF Cases", 
                       palette = "Reds", 
                       breaks = pretty_breaks())+
  facet_wrap(~, ncol = 6) +
   theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_rect(fill = "white", color = NA)) +
  labs(title = "Scaled DHF Cases in MDR 2001")

MDR_dengue_map_2001 %>%
  ggplot()+
  geom_sf(aes(fill = scaled_cases), color = "black", size = 0.25)+
  scale_fill_distiller(name = "DHF Cases", 
                       palette = "Reds", 
                       breaks = pretty_breaks())+
   theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_rect(fill = "white", color = NA)) +
  labs(title = "DHF Cases per 100,000 People in MDR 2001")

#2002
MDR_dengue_map_2002 <- MDR_dengue_heatmap %>%
  filter(year == 2002)

MDR_dengue_map_2002 %>%
  ggplot()+
  geom_sf(aes(fill = scaled_cases), color = "black", size = 0.25)+
  scale_fill_distiller(name = "DHF Cases", 
                       palette = "RdBu", 
                       breaks = pretty_breaks())+
   theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_rect(fill = "white", color = NA)) +
  labs(title = "Scaled DHF Cases in MDR 2002")


```
